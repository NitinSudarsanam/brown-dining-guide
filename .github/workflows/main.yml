name: Build and Deploy Next.js

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      # Step 1: Checkout code
      - name: Checkout code
        uses: actions/checkout@v4

      # Step 2: Setup Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # Step 3: Install dependencies
      - name: Install dependencies
        run: npm install
        shell: powershell

      # Step 4: Detect if app is static
      - name: Check for static export
        id: check_static
        run: |
          $pagesDir = Join-Path "${{ github.workspace }}" "pages"
          $usesSSR = Get-ChildItem $pagesDir -Recurse | Select-String "getServerSideProps|API"
          if ($usesSSR) {
              Write-Output "App uses SSR or API routes"
              echo "static=false" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8
          } else {
              Write-Output "App is fully static"
              echo "static=true" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8
          }
        shell: powershell

      # Step 5: Build Next.js
      - name: Build Next.js app
        run: npm run build
        shell: powershell

      # Step 6A: Deploy if static
      - name: Deploy static site
        if: steps.check_static.outputs.static == 'true'
        run: |
          npm run export
          $exportDir = Join-Path "${{ github.workspace }}" "out"
          $websiteDir = "D:\Github\test\website"

          if (!(Test-Path $websiteDir)) {
              New-Item -ItemType Directory -Path $websiteDir
          }

          # Clean old files
          Get-ChildItem -Path $websiteDir -Recurse | Remove-Item -Force -Recurse

          # Copy static files
          Copy-Item -Path "$exportDir\*" -Destination $websiteDir -Recurse -Force
          Write-Output "Static site deployed!"
        shell: powershell

      # Step 6B: Start SSR server
      - name: Start SSR server
        if: steps.check_static.outputs.static == 'false'
        run: |
          $serviceName = "NextJSServer"
          $nodePath = "C:\Users\JanaD\AppData\Roaming\npm\node.exe"
          $nextStart = Join-Path "${{ github.workspace }}" "node_modules\next\dist\bin\next"
          
          # Stop existing service
          if (Get-Service $serviceName -ErrorAction SilentlyContinue) {
              Stop-Service $serviceName -Force
          }

          # Install service if it doesn't exist
          if (-not (Get-Service $serviceName -ErrorAction SilentlyContinue)) {
              Write-Output "Installing NSSM service..."
              & nssm install $serviceName $nodePath "$nextStart start" "${{ github.workspace }}"
          }

          # Start the service
          Start-Service $serviceName
          Write-Output "Next.js SSR server running as service."
        shell: powershell
